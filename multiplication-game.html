<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>‰πòÊ≥ïÂè£ËØÄË°®ËÆ≠ÁªÉÊ∏∏Êàè</title>
<style>
  * { box-sizing: border-box; }
  
  body { 
    background: #f2f2f7;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
    text-align: center; 
    margin: 0; 
    padding: 20px;
    min-height: 100vh;
    color: #1d1d1f;
  }
  
  .container {
    max-width: 800px;
    margin: 0 auto;
    background: #ffffff;
    border-radius: 20px;
    padding: 40px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(0, 0, 0, 0.05);
  }
  
  h1 {
    color: #1d1d1f;
    margin-bottom: 40px;
    font-size: 2.5em;
    font-weight: 600;
    letter-spacing: -0.02em;
  }
  
  .game-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 40px;
    padding: 20px;
    background: #f8f8f8;
    border-radius: 16px;
    border: none;
  }
  
  .timer {
    font-size: 24px;
    font-weight: 500;
    color: #ff3b30;
  }
  
  .score {
    font-size: 20px;
    color: #34c759;
    font-weight: 500;
  }
  
  .question-area {
    background: #ffffff;
    border-radius: 20px;
    padding: 50px;
    margin: 40px 0;
    border: 1px solid #e5e5e7;
  }
  
  .question {
    font-size: 48px;
    font-weight: 300;
    color: #1d1d1f;
    margin-bottom: 40px;
    letter-spacing: -0.02em;
  }
  
  .answer-input {
    font-size: 36px;
    width: 180px;
    padding: 16px 20px;
    text-align: center;
    border: 2px solid #d1d1d6;
    border-radius: 12px;
    outline: none;
    transition: all 0.2s ease;
    background: #ffffff;
    font-weight: 400;
  }
  
  .answer-input:focus {
    border-color: #007aff;
    box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
  }
  
  .answer-input.correct {
    border-color: #34c759;
    background-color: rgba(52, 199, 89, 0.05);
  }
  
  .answer-input.incorrect {
    border-color: #ff3b30;
    background-color: rgba(255, 59, 48, 0.05);
    animation: shake 0.4s ease-in-out;
  }
  
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-4px); }
    75% { transform: translateX(4px); }
  }
  
  .buttons {
    margin: 40px 0;
  }
  
  .btn {
    font-size: 17px;
    padding: 14px 28px;
    margin: 0 8px;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-weight: 500;
    min-width: 120px;
  }
  
  .btn-primary {
    background: #007aff;
    color: white;
  }
  
  .btn-primary:hover {
    background: #0056cc;
    transform: translateY(-1px);
  }
  
  .btn-secondary {
    background: #34c759;
    color: white;
  }
  
  .btn-secondary:hover {
    background: #28a745;
    transform: translateY(-1px);
  }
  
  .stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 16px;
    margin-top: 40px;
  }
  
  .stat-card {
    background: #f8f8f8;
    padding: 24px 16px;
    border-radius: 16px;
    border: none;
  }
  
  .stat-number {
    font-size: 32px;
    font-weight: 300;
    color: #1d1d1f;
    letter-spacing: -0.02em;
  }
  
  .stat-label {
    font-size: 13px;
    color: #8e8e93;
    margin-top: 8px;
    font-weight: 400;
  }
  
  .feedback {
    font-size: 18px;
    font-weight: 500;
    margin: 30px 0;
    padding: 16px;
    border-radius: 12px;
    min-height: 54px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .feedback.correct {
    background: rgba(52, 199, 89, 0.1);
    color: #1e7e34;
  }
  
  .feedback.incorrect {
    background: rgba(255, 59, 48, 0.1);
    color: #d32f2f;
  }
  
  .game-over {
    background: #ffffff;
    border: 1px solid #e5e5e7;
    border-radius: 20px;
    padding: 40px;
    margin: 30px 0;
  }
  
  .final-score {
    font-size: 48px;
    color: #007aff;
    font-weight: 300;
    margin: 30px 0;
    letter-spacing: -0.02em;
  }
  
  .settings-section {
    background: #f8f8f8;
    border-radius: 16px;
    padding: 20px;
    margin: 20px 0;
    text-align: center;
  }
  
  .setting-group {
    margin-bottom: 20px;
  }
  
  .options-row {
    display: flex;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 10px;
  }
  
  .setting-btn {
    padding: 10px 20px;
    border: 2px solid #d1d1d6;
    border-radius: 20px;
    background: #ffffff;
    color: #1d1d1f;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 14px;
    font-weight: 500;
    min-width: 80px;
  }
  
  .setting-btn:hover {
    border-color: #34c759;
    background: rgba(52, 199, 89, 0.05);
  }
  
  .setting-btn.active {
    border-color: #34c759;
    background: #34c759;
    color: white;
  }
  
  .custom-range, .custom-time {
    display: flex;
    align-items: center;
    justify-content: center;
    flex-wrap: wrap;
    gap: 10px;
  }
  
  .time-settings {
    background: #f8f8f8;
    border-radius: 16px;
    padding: 20px;
    margin: 30px 0;
    text-align: center;
  }
  
  .time-options {
    display: flex;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 10px;
  }
  
  .time-btn {
    padding: 10px 20px;
    border: 2px solid #d1d1d6;
    border-radius: 20px;
    background: #ffffff;
    color: #1d1d1f;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 14px;
    font-weight: 500;
    min-width: 80px;
  }
  
  .time-btn:hover {
    border-color: #007aff;
    background: rgba(0, 122, 255, 0.05);
  }
  
  .time-btn.active {
    border-color: #007aff;
    background: #007aff;
    color: white;
  }
  
  .custom-time {
    display: flex;
    align-items: center;
    justify-content: center;
    flex-wrap: wrap;
    gap: 10px;
  }
  
  /* Ê®°ÊÄÅÂØπËØùÊ°ÜÊ†∑Âºè */
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(2px);
  }
  
  .modal-content {
    background-color: #fff;
    margin: 5% auto;
    padding: 30px;
    border-radius: 20px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    border: none;
    position: relative;
  }
  
  .close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    position: absolute;
    right: 20px;
    top: 15px;
    cursor: pointer;
  }
  
  .close:hover,
  .close:focus {
    color: #000;
    text-decoration: none;
  }
  
  .modal-header {
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 1px solid #eee;
  }
  
  .modal-header h2 {
    margin: 0;
    color: #1d1d1f;
    font-size: 24px;
  }
  
  .modal-body {
    margin-bottom: 25px;
  }
  
  .setting-section {
    margin-bottom: 30px;
  }
  
  .setting-section:last-child {
    margin-bottom: 0;
  }
  
  .setting-section h3 {
    color: #1d1d1f;
    font-size: 18px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .options-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
  }
  
  .option-btn {
    padding: 12px 10px;
    border: 2px solid #d1d1d6;
    border-radius: 12px;
    background: #ffffff;
    color: #1d1d1f;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 14px;
    font-weight: 500;
    text-align: center;
  }
  
  .option-btn:hover {
    border-color: #34c759;
    background: rgba(52, 199, 89, 0.05);
  }
  
  .option-btn.active {
    border-color: #34c759;
    background: #34c759;
    color: white;
  }
  
  .custom-input-group {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
  }
  
  .custom-input {
    width: 100px;
    padding: 10px;
    border: 1px solid #d1d1d6;
    border-radius: 8px;
    text-align: center;
    font-size: 14px;
  }
  
  .custom-input:focus {
    outline: none;
    border-color: #34c759;
    box-shadow: 0 0 0 2px rgba(52, 199, 89, 0.2);
  }
  
  .set-btn {
    padding: 10px 16px;
    background: #007aff;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s ease;
  }
  
  .set-btn:hover {
    background: #0056cc;
  }
</style>
</head>
<body>
<div class="container">
  <h1>üéØ Êï∞Â≠¶ËøêÁÆóËÆ≠ÁªÉÊ∏∏Êàè</h1>
  
  <!-- ËÆæÁΩÆÊåâÈíÆ -->
  <div style="text-align: center; margin: 20px 0; display: none;" id="settingsButton">
    <button class="btn btn-primary" onclick="openSettingsModal()" style="background: #34c759; border-color: #34c759;">‚öôÔ∏è Ê∏∏ÊàèËÆæÁΩÆ</button>
  </div>
  
  <!-- Ê®°ÊÄÅÂØπËØùÊ°Ü -->
  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeSettingsModal()">&times;</span>
      <div class="modal-header">
        <h2>Ê∏∏ÊàèÂâØÊú¨ËÆæÁΩÆ</h2>
      </div>
      <div class="modal-body">
        <!-- ËåÉÂõ¥ÈÄâÊã© -->
        <div class="setting-section">
          <h3>üéØ ËåÉÂõ¥ÈÄâÊã©</h3>
          <div class="options-grid">
            <button class="option-btn active" onclick="modalSelectRange(10)" id="modalRange10">10</button>
            <button class="option-btn" onclick="modalSelectRange(50)" id="modalRange50">50</button>
            <button class="option-btn" onclick="modalSelectRange(100)" id="modalRange100">100</button>
          </div>
          <div class="custom-input-group">
            <label for="modalCustomRangeInput">Ëá™ÂÆö‰πâËåÉÂõ¥Ôºö</label>
            <input type="number" id="modalCustomRangeInput" class="custom-input" min="1" max="1000" value="10" oninput="updateModalCustomRange()">
            <button class="set-btn" onclick="setModalCustomRange()">ËÆæÁΩÆ</button>
          </div>
        </div>
        
        <!-- Á±ªÂûãÈÄâÊã© -->
        <div class="setting-section">
          <h3>üßÆ ËøêÁÆóÁ±ªÂûã</h3>
          <div class="options-grid">
            <button class="option-btn active" onclick="modalSelectOperation('multiplication')" id="modalOpMultiplication">‰πòÊ≥ï</button>
            <button class="option-btn" onclick="modalSelectOperation('addition')" id="modalOpAddition">Âä†Ê≥ï</button>
            <button class="option-btn" onclick="modalSelectOperation('subtraction')" id="modalOpSubtraction">ÂáèÊ≥ï</button>
            <button class="option-btn" onclick="modalSelectOperation('division')" id="modalOpDivision">Èô§Ê≥ï</button>
          </div>
        </div>
        
        <!-- ÈöæÂ∫¶ÈÄâÊã© -->
        <div class="setting-section">
          <h3>‚ö° ÈöæÂ∫¶ÈÄâÊã©</h3>
          <div class="options-grid" id="modalDifficultyOptions">
            <button class="option-btn active" onclick="modalSelectDifficulty('noCarry')" id="modalDiffNoCarry">‰∏çËøõ‰Ωç</button>
            <button class="option-btn" onclick="modalSelectDifficulty('carry')" id="modalDiffCarry">Ëøõ‰Ωç</button>
          </div>
        </div>
        
        <!-- Êó∂Èó¥ÈÄâÊã© -->
        <div class="setting-section">
          <h3>‚è±Ô∏è Ê∏∏ÊàèÊó∂Èïø</h3>
          <div class="options-grid">
            <button class="option-btn" onclick="modalSelectTime(60, this)">1ÂàÜÈíü</button>
            <button class="option-btn active" onclick="modalSelectTime(120, this)">2ÂàÜÈíü</button>
            <button class="option-btn" onclick="modalSelectTime(180, this)">3ÂàÜÈíü</button>
            <button class="option-btn" onclick="modalSelectTime(300, this)">5ÂàÜÈíü</button>
          </div>
          <div class="custom-input-group">
            <label for="modalCustomTimeInput">Ëá™ÂÆö‰πâÊó∂Èó¥ÔºàÁßíÔºâÔºö</label>
            <input type="number" id="modalCustomTimeInput" class="custom-input" min="30" max="1800" value="120">
            <button class="set-btn" onclick="setModalCustomTime()">ËÆæÁΩÆ</button>
          </div>
        </div>
      </div>
      <div style="text-align: center; padding-top: 20px;">
        <div style="margin-bottom: 15px; text-align: left;">
          <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="checkbox" id="alwaysShowSettings" style="margin-right: 10px; transform: scale(1.2);">
            <span>ÊØèÊ¨°ÂêØÂä®Êó∂ÈÉΩÊòæÁ§∫ËÆæÁΩÆÂØπËØùÊ°Ü</span>
          </label>
        </div>
        <button class="btn btn-primary" onclick="saveSettingsAndClose()" style="padding: 12px 30px; font-size: 16px;">‰øùÂ≠òËÆæÁΩÆ</button>
      </div>
    </div>
  </div>
  
  <div class="settings-section" id="gameSettings" style="display: none;">
    <!-- ËåÉÂõ¥ÈÄâÊã© -->
    <div class="setting-group">
      <h3 style="color: #1d1d1f; font-size: 18px; margin-bottom: 15px;">üéØ ËåÉÂõ¥ÈÄâÊã©</h3>
      <div class="options-row">
        <button class="setting-btn active" onclick="selectRange(10)" id="range10">10</button>
        <button class="setting-btn" onclick="selectRange(50)" id="range50">50</button>
        <button class="setting-btn" onclick="selectRange(100)" id="range100">100</button>
        <div class="custom-range">
          <label for="customRangeInput" style="color: #8e8e93; font-size: 14px;">Ëá™ÂÆö‰πâÔºö</label>
          <input type="number" id="customRangeInput" min="1" max="1000" value="10" style="width: 80px; padding: 8px; border: 1px solid #d1d1d6; border-radius: 6px; margin: 0 10px; text-align: center;" oninput="updateCustomRange()">
          <button class="btn btn-secondary" onclick="setCustomRange()" style="padding: 8px 16px; font-size: 14px;">ËÆæÁΩÆ</button>
        </div>
      </div>
    </div>
    
    <!-- Á±ªÂûãÈÄâÊã© -->
    <div class="setting-group" style="margin-top: 25px;">
      <h3 style="color: #1d1d1f; font-size: 18px; margin-bottom: 15px;">üßÆ ËøêÁÆóÁ±ªÂûã</h3>
      <div class="options-row">
        <button class="setting-btn active" onclick="selectOperation('multiplication')" id="opMultiplication">‰πòÊ≥ï</button>
        <button class="setting-btn" onclick="selectOperation('addition')" id="opAddition">Âä†Ê≥ï</button>
        <button class="setting-btn" onclick="selectOperation('subtraction')" id="opSubtraction">ÂáèÊ≥ï</button>
        <button class="setting-btn" onclick="selectOperation('division')" id="opDivision">Èô§Ê≥ï</button>
      </div>
    </div>
    
    <!-- ÈöæÂ∫¶ÈÄâÊã© -->
    <div class="setting-group" style="margin-top: 25px;">
      <h3 style="color: #1d1d1f; font-size: 18px; margin-bottom: 15px;">‚ö° ÈöæÂ∫¶ÈÄâÊã©</h3>
      <div class="options-row" id="difficultyOptions">
        <button class="setting-btn active" onclick="selectDifficulty('noCarry')" id="diffNoCarry">‰∏çËøõ‰Ωç</button>
        <button class="setting-btn" onclick="selectDifficulty('carry')" id="diffCarry">Ëøõ‰Ωç</button>
      </div>
    </div>
  </div>
  
  <div class="time-settings" id="timeSettings" style="display: none;">
    <h3 style="color: #1d1d1f; font-size: 18px; margin-bottom: 15px;">‚è±Ô∏è ÈÄâÊã©Ê∏∏ÊàèÊó∂Èïø</h3>
    <div class="time-options">
      <button class="time-btn" onclick="selectTime(60, this)">1ÂàÜÈíü</button>
      <button class="time-btn active" onclick="selectTime(120, this)">2ÂàÜÈíü</button>
      <button class="time-btn" onclick="selectTime(180, this)">3ÂàÜÈíü</button>
      <button class="time-btn" onclick="selectTime(300, this)">5ÂàÜÈíü</button>
    </div>
    <div class="custom-time" style="margin-top: 15px;">
      <label for="customTimeInput" style="color: #8e8e93; font-size: 14px;">Ëá™ÂÆö‰πâÊó∂Èó¥ÔºàÁßíÔºâÔºö</label>
      <input type="number" id="customTimeInput" min="30" max="1800" value="120" style="width: 80px; padding: 8px; border: 1px solid #d1d1d6; border-radius: 6px; margin: 0 10px; text-align: center;">
      <button class="btn btn-secondary" onclick="setCustomTime()" style="padding: 8px 16px; font-size: 14px;">ËÆæÁΩÆ</button>
    </div>
  </div>
  
  <div class="game-info">
    <div class="timer">‚è∞ Êó∂Èó¥: <span id="timeLeft">60</span> Áßí</div>
    <div class="score">üåü ÂæóÂàÜ: <span id="currentScore">0</span></div>
  </div>
  
  <div class="question-area" id="questionArea">
    <div class="question" id="question">ÁÇπÂáªÂºÄÂßãÊåâÈíÆÂºÄÂßãÊ∏∏ÊàèÔºÅ</div>
    <input type="number" class="answer-input" id="answerInput" placeholder="?" style="display: none;" min="0" max="10000">
    <div class="options-container" id="optionsContainer" style="display: none; margin-top: 30px;">
      <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
        <button class="btn btn-primary" onclick="selectOption('A')" id="optionA" style="min-width: 100px; padding: 15px 20px; font-size: 24px; font-weight: bold;"><span id="optionAText">0</span></button>
        <button class="btn btn-primary" onclick="selectOption('B')" id="optionB" style="min-width: 100px; padding: 15px 20px; font-size: 24px; font-weight: bold; background-color: #007aff;"><span id="optionBText">0</span></button>
        <button class="btn btn-primary" onclick="selectOption('C')" id="optionC" style="min-width: 100px; padding: 15px 20px; font-size: 24px; font-weight: bold; background-color: #007aff;"><span id="optionCText">0</span></button>
      </div>
    </div>
    <div class="feedback" id="feedback"></div>
  </div>

  <div class="buttons">
    <button class="btn btn-primary" id="startBtn" onclick="startGame()" disabled style="opacity: 0.5;">üöÄ ÂºÄÂßãÊ∏∏Êàè</button>
    <button class="btn btn-secondary" onclick="restartGame()" style="display: none;" id="restartBtn">üîÑ ÈáçÊñ∞ÂºÄÂßã</button>
  </div>
  
  <div class="stats">
    <div class="stat-card">
      <div class="stat-number" id="totalQuestions">0</div>
      <div class="stat-label">ÊÄªÈ¢òÊï∞</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="correctAnswers">0</div>
      <div class="stat-label">Á≠îÂØπ</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="wrongAnswers">0</div>
      <div class="stat-label">Á≠îÈîô</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="accuracy">0%</div>
      <div class="stat-label">Ê≠£Á°ÆÁéá</div>
    </div>
  </div>
  
  <div class="game-over" id="gameOver" style="display: none;">
    <h2>üéâ Ê∏∏ÊàèÁªìÊùüÔºÅ</h2>
    <div class="final-score" id="finalScore"></div>
    <div id="finalStats"></div>
  </div>
</div>

<!-- Èü≥Êïà‰ΩøÁî®Web Audio APIÁîüÊàêÔºå‰∏çÈúÄË¶ÅÂ§ñÈÉ®Êñá‰ª∂ -->
<audio id="correctSound" preload="auto">
  <source src="hit_mole.mp3" type="audio/mp3">
  <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFA" type="audio/wav">
</audio>
<audio id="wrongSound" preload="auto">
  <source src="hit_bomb.mp3" type="audio/mp3">
  <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZBzuR2O/NeSsFJHfH8N2QQAoUXrTp66hVFA" type="audio/wav">
</audio>

<script>
// Ê∏∏ÊàèËÆæÁΩÆÂèòÈáè
let selectedRange = 10; // ÈªòËÆ§ËåÉÂõ¥
let selectedOperation = 'multiplication'; // ÈªòËÆ§ËøêÁÆóÁ±ªÂûã
let selectedDifficulty = 'noCarry'; // ÈªòËÆ§ÈöæÂ∫¶

let currentScore = 0;
let timeLeft = 120; // ÈªòËÆ§2ÂàÜÈíü
let selectedTime = 120; // Áî®Êà∑ÈÄâÊã©ÁöÑÊó∂Èó¥
let timer = null;
let gameActive = false;
let currentAnswer = 0;
let totalQuestions = 0;
let correctAnswers = 0;
let wrongAnswers = 0;

// A„ÄÅB„ÄÅCÈÄâÈ°πÁõ∏ÂÖ≥ÂèòÈáè
let optionA = 0;
let optionB = 0;
let optionC = 0;
let correctOption = ''; // 'A'„ÄÅ'B' Êàñ 'C'

// ‰∏ä‰∏ÄÈÅìÈ¢òÁõÆÁöÑ‰ø°ÊÅØÔºåÁî®‰∫éÈÅøÂÖçÈáçÂ§ç
let lastQuestion = {
  num1: 0,
  num2: 0,
  operation: '',
  answer: 0
};

// ‰ΩøÁî®Web Audio APIÂàõÂª∫Èü≥Êïà
let audioContext;
let correctSoundBuffer;
let wrongSoundBuffer;
let inputTimer; // Áî®‰∫éÊ£ÄÊµãÂÅúÊ≠¢ËæìÂÖ•ÁöÑÂÆöÊó∂Âô®
let hasAnswered = false; // Ê†áËÆ∞ÊòØÂê¶Â∑≤ÁªèÂõûÁ≠îËøáÂΩìÂâçÈ¢òÁõÆ

// ÂàùÂßãÂåñÈü≥È¢ë‰∏ä‰∏ãÊñá
function initAudio() {
  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
  }
}

// ÂàõÂª∫ÁÆÄÂçïÁöÑÊèêÁ§∫Èü≥
function createBeepSound(frequency, duration, type = 'sine') {
  if (!audioContext) return;
  
  const oscillator = audioContext.createOscillator();
  const gainNode = audioContext.createGain();
  
  oscillator.connect(gainNode);
  gainNode.connect(audioContext.destination);
  
  oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
  oscillator.type = type;
  
  gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
  gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
  
  oscillator.start(audioContext.currentTime);
  oscillator.stop(audioContext.currentTime + duration);
}

// Êí≠ÊîæÈü≥ÊïàÁöÑÂáΩÊï∞
function playSound(soundType) {
  try {
    initAudio();
    
    if (soundType === 'correctSound') {
      // Êí≠ÊîæÊÑâÂø´ÁöÑ‰∏äÂçáÈü≥Ë∞É
      createBeepSound(523.25, 0.1); // C5
      setTimeout(() => createBeepSound(659.25, 0.1), 50); // E5
      setTimeout(() => createBeepSound(783.99, 0.15), 100); // G5
    } else if (soundType === 'wrongSound') {
      // Êí≠Êîæ‰ΩéÊ≤âÁöÑÈîôËØØÈü≥
      createBeepSound(220, 0.3, 'sawtooth'); // A3
    }
  } catch (e) {
    console.log('Èü≥ÊïàÊí≠ÊîæÂ§±Ë¥•:', e);
  }
}

// ËåÉÂõ¥ÈÄâÊã©ÂáΩÊï∞
function selectRange(range) {
  selectedRange = range;
  
  // Áõ¥Êé•ÁßªÈô§ÊâÄÊúâÈ¢ÑËÆæËåÉÂõ¥ÊåâÈíÆÁöÑÊøÄÊ¥ªÁä∂ÊÄÅ
  document.getElementById('range10').classList.remove('active');
  document.getElementById('range50').classList.remove('active');
  document.getElementById('range100').classList.remove('active');
  
  // ÊøÄÊ¥ªÂΩìÂâçÈÄâÊã©ÁöÑÊåâÈíÆ
  if (range === 10) {
    document.getElementById('range10').classList.add('active');
  } else if (range === 50) {
    document.getElementById('range50').classList.add('active');
  } else if (range === 100) {
    document.getElementById('range100').classList.add('active');
  }
  
  // Êõ¥Êñ∞Ëá™ÂÆö‰πâËæìÂÖ•Ê°Ü
  document.getElementById('customRangeInput').value = range;
  
  // ÈáçÁΩÆËá™ÂÆö‰πâËæìÂÖ•Ê°ÜÁöÑËßÜËßâÁä∂ÊÄÅ
  resetCustomRangeStyle();
}

// ËÆæÁΩÆËá™ÂÆö‰πâËåÉÂõ¥
function setCustomRange() {
  const customRange = parseInt(document.getElementById('customRangeInput').value);
  if (customRange >= 1 && customRange <= 1000) {
    selectedRange = customRange;
    
    // Áõ¥Êé•ÁßªÈô§ÊâÄÊúâÈ¢ÑËÆæËåÉÂõ¥ÊåâÈíÆÁöÑÊøÄÊ¥ªÁä∂ÊÄÅ
    document.getElementById('range10').classList.remove('active');
    document.getElementById('range50').classList.remove('active');
    document.getElementById('range100').classList.remove('active');
    
    // ‰∏∫Ëá™ÂÆö‰πâËæìÂÖ•Ê°ÜÊ∑ªÂä†ËßÜËßâÂèçÈ¶à
    const customRangeInput = document.getElementById('customRangeInput');
    customRangeInput.style.borderColor = '#34c759';
    customRangeInput.style.boxShadow = '0 0 0 2px rgba(52, 199, 89, 0.2)';
  } else {
    alert('ËØ∑ËæìÂÖ•1-1000‰πãÈó¥ÁöÑÊï∞Â≠óÔºÅ');
  }
}

// ÂΩìÁî®Êà∑Âú®Ëá™ÂÆö‰πâËæìÂÖ•Ê°Ü‰∏≠ËæìÂÖ•Êó∂ÔºåËá™Âä®Â∫îÁî®ËØ•ÂÄº‰∏∫ÈÄâ‰∏≠ËåÉÂõ¥
function updateCustomRange() {
  const customRangeInput = document.getElementById('customRangeInput');
  const customRange = parseInt(customRangeInput.value);
  if (!isNaN(customRange) && customRange >= 1 && customRange <= 1000) {
    selectedRange = customRange;
    
    // Áõ¥Êé•ÁßªÈô§ÊâÄÊúâÈ¢ÑËÆæËåÉÂõ¥ÊåâÈíÆÁöÑÊøÄÊ¥ªÁä∂ÊÄÅ
    document.getElementById('range10').classList.remove('active');
    document.getElementById('range50').classList.remove('active');
    document.getElementById('range100').classList.remove('active');
    
    // ‰∏∫Ëá™ÂÆö‰πâËæìÂÖ•Ê°ÜÊ∑ªÂä†ËßÜËßâÂèçÈ¶à
    customRangeInput.style.borderColor = '#34c759';
    customRangeInput.style.boxShadow = '0 0 0 2px rgba(52, 199, 89, 0.2)';
  }
}

// ÈáçÁΩÆËá™ÂÆö‰πâËæìÂÖ•Ê°ÜÁöÑËßÜËßâÁä∂ÊÄÅ
function resetCustomRangeStyle() {
  const customRangeInput = document.getElementById('customRangeInput');
  customRangeInput.style.borderColor = '#d1d1d6';
  customRangeInput.style.boxShadow = 'none';
}

// ËøêÁÆóÁ±ªÂûãÈÄâÊã©ÂáΩÊï∞
function selectOperation(operation) {
  selectedOperation = operation;
  
  // Êõ¥Êñ∞ÁïåÈù¢ÊòæÁ§∫
  const buttons = document.querySelectorAll('#gameSettings .options-row:nth-child(2) .setting-btn');
  buttons.forEach(btn => btn.classList.remove('active'));
  
  if (operation === 'multiplication') {
    document.getElementById('opMultiplication').classList.add('active');
  } else if (operation === 'addition') {
    document.getElementById('opAddition').classList.add('active');
  } else if (operation === 'subtraction') {
    document.getElementById('opSubtraction').classList.add('active');
  } else if (operation === 'division') {
    document.getElementById('opDivision').classList.add('active');
  }
  
  // Ê†πÊçÆËøêÁÆóÁ±ªÂûãÊõ¥Êñ∞ÈöæÂ∫¶ÈÄâÈ°πÊòæÁ§∫
  updateDifficultyOptions();
}

// Êõ¥Êñ∞ÈöæÂ∫¶ÈÄâÈ°πÊòæÁ§∫
function updateDifficultyOptions() {
  const difficultyOptions = document.getElementById('difficultyOptions');
  
  if (selectedOperation === 'addition' || selectedOperation === 'multiplication') {
    difficultyOptions.innerHTML = `
      <button class="setting-btn active" onclick="selectDifficulty('noCarry')" id="diffNoCarry">‰∏çËøõ‰Ωç</button>
      <button class="setting-btn" onclick="selectDifficulty('carry')" id="diffCarry">Ëøõ‰Ωç</button>
    `;
  } else {
    difficultyOptions.innerHTML = `
      <button class="setting-btn active" onclick="selectDifficulty('noCarry')" id="diffNoCarry">‰∏çÈÄÄ‰Ωç</button>
      <button class="setting-btn" onclick="selectDifficulty('carry')" id="diffCarry">ÈÄÄ‰Ωç</button>
    `;
  }
  
  // ÈáçÊñ∞ËÆæÁΩÆÂΩìÂâçÈÄâ‰∏≠ÁöÑÈöæÂ∫¶
  if (selectedDifficulty === 'noCarry') {
    document.getElementById('diffNoCarry').classList.add('active');
  } else {
    document.getElementById('diffCarry').classList.add('active');
  }
}

// ÈöæÂ∫¶ÈÄâÊã©ÂáΩÊï∞
function selectDifficulty(difficulty) {
  selectedDifficulty = difficulty;
  
  // Êõ¥Êñ∞ÁïåÈù¢ÊòæÁ§∫
  const buttons = document.querySelectorAll('#difficultyOptions .setting-btn');
  buttons.forEach(btn => btn.classList.remove('active'));
  
  if (difficulty === 'noCarry') {
    document.getElementById('diffNoCarry').classList.add('active');
  } else {
    document.getElementById('diffCarry').classList.add('active');
  }
}

// Ê®°ÊÄÅÂØπËØùÊ°ÜÂáΩÊï∞
function openSettingsModal() {
  // ÂàùÂßãÂåñÊ®°ÊÄÅÂØπËØùÊ°Ü‰∏≠ÁöÑËÆæÁΩÆÂÄº
  initializeModalSettings();
  document.getElementById('settingsModal').style.display = 'block';
}

function closeSettingsModal() {
  document.getElementById('settingsModal').style.display = 'none';
}

// ÂàùÂßãÂåñÊ®°ÊÄÅÂØπËØùÊ°Ü‰∏≠ÁöÑËÆæÁΩÆÂÄº
function initializeModalSettings() {
  // ËåÉÂõ¥ÈÄâÊã©
  const rangeButtons = document.querySelectorAll('#settingsModal .options-grid:first-child .option-btn');
  rangeButtons.forEach(btn => btn.classList.remove('active'));
  
  if (selectedRange === 10) {
    document.getElementById('modalRange10').classList.add('active');
  } else if (selectedRange === 50) {
    document.getElementById('modalRange50').classList.add('active');
  } else if (selectedRange === 100) {
    document.getElementById('modalRange100').classList.add('active');
  } else {
    // Ëá™ÂÆö‰πâËåÉÂõ¥
    document.getElementById('modalCustomRangeInput').value = selectedRange;
  }
  
  // Á±ªÂûãÈÄâÊã©
  const operationButtons = document.querySelectorAll('#settingsModal .setting-section:nth-child(2) .option-btn');
  operationButtons.forEach(btn => btn.classList.remove('active'));
  
  if (selectedOperation === 'multiplication') {
    document.getElementById('modalOpMultiplication').classList.add('active');
  } else if (selectedOperation === 'addition') {
    document.getElementById('modalOpAddition').classList.add('active');
  } else if (selectedOperation === 'subtraction') {
    document.getElementById('modalOpSubtraction').classList.add('active');
  } else if (selectedOperation === 'division') {
    document.getElementById('modalOpDivision').classList.add('active');
  }
  
  // ÈöæÂ∫¶ÈÄâÊã©
  updateModalDifficultyOptions();
  
  // Êó∂Èó¥ÈÄâÊã©
  const timeButtons = document.querySelectorAll('#settingsModal .setting-section:nth-child(4) .option-btn');
  timeButtons.forEach(btn => btn.classList.remove('active'));
  
  if (selectedTime === 60) {
    document.querySelector('#settingsModal .setting-section:nth-child(4) .option-btn:nth-child(1)').classList.add('active');
  } else if (selectedTime === 120) {
    document.querySelector('#settingsModal .setting-section:nth-child(4) .option-btn:nth-child(2)').classList.add('active');
  } else if (selectedTime === 180) {
    document.querySelector('#settingsModal .setting-section:nth-child(4) .option-btn:nth-child(3)').classList.add('active');
  } else if (selectedTime === 300) {
    document.querySelector('#settingsModal .setting-section:nth-child(4) .option-btn:nth-child(4)').classList.add('active');
  }
  
  // Ëá™ÂÆö‰πâÊó∂Èó¥ËæìÂÖ•Ê°Ü
  document.getElementById('modalCustomTimeInput').value = selectedTime;
  
  // ËÆæÁΩÆ"ÊØèÊ¨°ÂêØÂä®Êó∂ÈÉΩÊòæÁ§∫ËÆæÁΩÆÂØπËØùÊ°Ü"Â§çÈÄâÊ°ÜÁöÑÁä∂ÊÄÅ
  const alwaysShowSettings = localStorage.getItem('showSettingsOnLoad');
  document.getElementById('alwaysShowSettings').checked = (alwaysShowSettings !== 'false');
}

// Êõ¥Êñ∞Ê®°ÊÄÅÂØπËØùÊ°Ü‰∏≠ÁöÑÈöæÂ∫¶ÈÄâÈ°πÊòæÁ§∫
function updateModalDifficultyOptions() {
  const difficultyOptions = document.getElementById('modalDifficultyOptions');
  
  if (selectedOperation === 'addition' || selectedOperation === 'multiplication') {
    difficultyOptions.innerHTML = `
      <button class="option-btn active" onclick="modalSelectDifficulty('noCarry')" id="modalDiffNoCarry">‰∏çËøõ‰Ωç</button>
      <button class="option-btn" onclick="modalSelectDifficulty('carry')" id="modalDiffCarry">Ëøõ‰Ωç</button>
    `;
  } else {
    difficultyOptions.innerHTML = `
      <button class="option-btn active" onclick="modalSelectDifficulty('noCarry')" id="modalDiffNoCarry">‰∏çÈÄÄ‰Ωç</button>
      <button class="option-btn" onclick="modalSelectDifficulty('carry')" id="modalDiffCarry">ÈÄÄ‰Ωç</button>
    `;
  }
  
  // ÈáçÊñ∞ËÆæÁΩÆÂΩìÂâçÈÄâ‰∏≠ÁöÑÈöæÂ∫¶
  if (selectedDifficulty === 'noCarry') {
    document.getElementById('modalDiffNoCarry').classList.add('active');
  } else {
    document.getElementById('modalDiffCarry').classList.add('active');
  }
}

// ÈáçÁΩÆÊ®°ÊÄÅÂØπËØùÊ°Ü‰∏≠ÁöÑËá™ÂÆö‰πâËåÉÂõ¥ËæìÂÖ•Ê°ÜËßÜËßâÁä∂ÊÄÅ
function resetModalCustomRangeStyle() {
  const customRangeInput = document.getElementById('modalCustomRangeInput');
  customRangeInput.style.borderColor = '#d1d1d6';
  customRangeInput.style.boxShadow = 'none';
}

// Ê®°ÊÄÅÂØπËØùÊ°Ü‰∏≠ÁöÑËåÉÂõ¥ÈÄâÊã©ÂáΩÊï∞
function modalSelectRange(range) {
  selectedRange = range;
  
  // Áõ¥Êé•ÁßªÈô§ÊâÄÊúâÈ¢ÑËÆæËåÉÂõ¥ÊåâÈíÆÁöÑÊøÄÊ¥ªÁä∂ÊÄÅ
  document.getElementById('modalRange10').classList.remove('active');
  document.getElementById('modalRange50').classList.remove('active');
  document.getElementById('modalRange100').classList.remove('active');
  
  // ÁßªÈô§Ëá™ÂÆö‰πâËæìÂÖ•Ê°ÜÁöÑÊøÄÊ¥ªÊ†∑Âºè
  resetModalCustomRangeStyle();
  
  // ÊøÄÊ¥ªÂΩìÂâçÈÄâÊã©ÁöÑÊåâÈíÆ
  if (range === 10) {
    document.getElementById('modalRange10').classList.add('active');
  } else if (range === 50) {
    document.getElementById('modalRange50').classList.add('active');
  } else if (range === 100) {
    document.getElementById('modalRange100').classList.add('active');
  }
  
  // Êõ¥Êñ∞Ëá™ÂÆö‰πâËæìÂÖ•Ê°ÜÁöÑÂÄº
  document.getElementById('modalCustomRangeInput').value = range;
}

// Ê®°ÊÄÅÂØπËØùÊ°Ü‰∏≠ÁöÑËá™ÂÆö‰πâËåÉÂõ¥Êõ¥Êñ∞ÂáΩÊï∞
function updateModalCustomRange() {
  const customRangeInput = document.getElementById('modalCustomRangeInput');
  const customRange = parseInt(customRangeInput.value);
  if (!isNaN(customRange) && customRange >= 1 && customRange <= 1000) {
    selectedRange = customRange;
    
    // Áõ¥Êé•ÁßªÈô§ÊâÄÊúâÈ¢ÑËÆæËåÉÂõ¥ÊåâÈíÆÁöÑÊøÄÊ¥ªÁä∂ÊÄÅ
    document.getElementById('modalRange10').classList.remove('active');
    document.getElementById('modalRange50').classList.remove('active');
    document.getElementById('modalRange100').classList.remove('active');
    
    // ‰∏∫Ëá™ÂÆö‰πâËæìÂÖ•Ê°ÜÊ∑ªÂä†ËßÜËßâÂèçÈ¶à
    customRangeInput.style.borderColor = '#34c759';
    customRangeInput.style.boxShadow = '0 0 0 2px rgba(52, 199, 89, 0.2)';
  }
}

// Ê®°ÊÄÅÂØπËØùÊ°Ü‰∏≠ÁöÑËÆæÁΩÆËá™ÂÆö‰πâËåÉÂõ¥ÂáΩÊï∞
function setModalCustomRange() {
  const customRange = parseInt(document.getElementById('modalCustomRangeInput').value);
  if (customRange >= 1 && customRange <= 1000) {
    selectedRange = customRange;
    
    // Áõ¥Êé•ÁßªÈô§ÊâÄÊúâÈ¢ÑËÆæËåÉÂõ¥ÊåâÈíÆÁöÑÊøÄÊ¥ªÁä∂ÊÄÅ
    document.getElementById('modalRange10').classList.remove('active');
    document.getElementById('modalRange50').classList.remove('active');
    document.getElementById('modalRange100').classList.remove('active');
    
    // ‰∏∫Ëá™ÂÆö‰πâËæìÂÖ•Ê°ÜÊ∑ªÂä†ËßÜËßâÂèçÈ¶à
    const customRangeInput = document.getElementById('modalCustomRangeInput');
    customRangeInput.style.borderColor = '#34c759';
    customRangeInput.style.boxShadow = '0 0 0 2px rgba(52, 199, 89, 0.2)';
  } else {
    alert('ËØ∑ËæìÂÖ•1-1000‰πãÈó¥ÁöÑÊï∞Â≠óÔºÅ');
  }
}

// Ê®°ÊÄÅÂØπËØùÊ°Ü‰∏≠ÁöÑËøêÁÆóÁ±ªÂûãÈÄâÊã©ÂáΩÊï∞
function modalSelectOperation(operation) {
  selectedOperation = operation;
  
  const buttons = document.querySelectorAll('#settingsModal .setting-section:nth-child(2) .option-btn');
  buttons.forEach(btn => btn.classList.remove('active'));
  
  if (operation === 'multiplication') {
    document.getElementById('modalOpMultiplication').classList.add('active');
  } else if (operation === 'addition') {
    document.getElementById('modalOpAddition').classList.add('active');
  } else if (operation === 'subtraction') {
    document.getElementById('modalOpSubtraction').classList.add('active');
  } else if (operation === 'division') {
    document.getElementById('modalOpDivision').classList.add('active');
  }
  
  // Ê†πÊçÆËøêÁÆóÁ±ªÂûãÊõ¥Êñ∞ÈöæÂ∫¶ÈÄâÈ°πÊòæÁ§∫
  updateModalDifficultyOptions();
}

// Ê®°ÊÄÅÂØπËØùÊ°Ü‰∏≠ÁöÑÈöæÂ∫¶ÈÄâÊã©ÂáΩÊï∞
function modalSelectDifficulty(difficulty) {
  const buttons = document.querySelectorAll('#modalDifficultyOptions .option-btn');
  buttons.forEach(btn => btn.classList.remove('active'));
  
  if (difficulty === 'noCarry') {
    document.getElementById('modalDiffNoCarry').classList.add('active');
  } else {
    document.getElementById('modalDiffCarry').classList.add('active');
  }
}

// Ê®°ÊÄÅÂØπËØùÊ°Ü‰∏≠ÁöÑÊó∂Èó¥ÈÄâÊã©ÂáΩÊï∞
function modalSelectTime(seconds, element) {
  const buttons = document.querySelectorAll('#settingsModal .setting-section:nth-child(4) .option-btn');
  buttons.forEach(btn => btn.classList.remove('active'));
  element.classList.add('active');
}

// Ê®°ÊÄÅÂØπËØùÊ°Ü‰∏≠ÁöÑËÆæÁΩÆËá™ÂÆö‰πâÊó∂Èó¥ÂáΩÊï∞
function setModalCustomTime() {
  const customTime = parseInt(document.getElementById('modalCustomTimeInput').value);
  if (customTime < 30 || customTime > 1800) {
    alert('ËØ∑ËæìÂÖ•30-1800Áßí‰πãÈó¥ÁöÑÊó∂Èó¥ÔºÅ');
  }
}

// ‰øùÂ≠òËÆæÁΩÆÂπ∂ÂÖ≥Èó≠Ê®°ÊÄÅÂØπËØùÊ°Ü
function saveSettingsAndClose() {
  // Ëé∑ÂèñÊ®°ÊÄÅÂØπËØùÊ°Ü‰∏≠ÁöÑËÆæÁΩÆÂÄºÂπ∂Â∫îÁî®Âà∞‰∏ªËÆæÁΩÆ‰∏≠
  // ËåÉÂõ¥ËÆæÁΩÆ
  const rangeButtons = document.querySelectorAll('#settingsModal .options-grid:first-child .option-btn.active');
  if (rangeButtons.length > 0) {
    // Ê£ÄÊü•ÊòØÂê¶ÈÄâÊã©‰∫ÜÈ¢ÑËÆæËåÉÂõ¥
    if (document.getElementById('modalRange10').classList.contains('active')) {
      selectRange(10);
    } else if (document.getElementById('modalRange50').classList.contains('active')) {
      selectRange(50);
    } else if (document.getElementById('modalRange100').classList.contains('active')) {
      selectRange(100);
    } else {
      // ‰ΩøÁî®Ëá™ÂÆö‰πâËåÉÂõ¥
      const customRange = parseInt(document.getElementById('modalCustomRangeInput').value);
      if (customRange >= 1 && customRange <= 1000) {
        selectedRange = customRange;
        resetCustomRangeStyle();
      }
    }
  }
  
  // Á±ªÂûãËÆæÁΩÆ
  if (document.getElementById('modalOpMultiplication').classList.contains('active')) {
    selectOperation('multiplication');
  } else if (document.getElementById('modalOpAddition').classList.contains('active')) {
    selectOperation('addition');
  } else if (document.getElementById('modalOpSubtraction').classList.contains('active')) {
    selectOperation('subtraction');
  } else if (document.getElementById('modalOpDivision').classList.contains('active')) {
    selectOperation('division');
  }
  
  // ÈöæÂ∫¶ËÆæÁΩÆ
  if (document.getElementById('modalDiffNoCarry').classList.contains('active')) {
    selectDifficulty('noCarry');
  } else if (document.getElementById('modalDiffCarry').classList.contains('active')) {
    selectDifficulty('carry');
  }
  
  // Êó∂Èó¥ËÆæÁΩÆ
  const timeButtons = document.querySelectorAll('#settingsModal .setting-section:nth-child(4) .option-btn.active');
  if (timeButtons.length > 0) {
    if (document.querySelector('#settingsModal .setting-section:nth-child(4) .option-btn:nth-child(1)').classList.contains('active')) {
      selectTime(60, document.querySelector('.time-btn:nth-child(1)'));
    } else if (document.querySelector('#settingsModal .setting-section:nth-child(4) .option-btn:nth-child(2)').classList.contains('active')) {
      selectTime(120, document.querySelector('.time-btn:nth-child(2)'));
    } else if (document.querySelector('#settingsModal .setting-section:nth-child(4) .option-btn:nth-child(3)').classList.contains('active')) {
      selectTime(180, document.querySelector('.time-btn:nth-child(3)'));
    } else if (document.querySelector('#settingsModal .setting-section:nth-child(4) .option-btn:nth-child(4)').classList.contains('active')) {
      selectTime(300, document.querySelector('.time-btn:nth-child(4)'));
    } else {
      // ‰ΩøÁî®Ëá™ÂÆö‰πâÊó∂Èó¥
      const customTime = parseInt(document.getElementById('modalCustomTimeInput').value);
      if (customTime >= 30 && customTime <= 1800) {
        selectedTime = customTime;
        timeLeft = customTime;
        document.getElementById('timeLeft').textContent = timeLeft;
        document.getElementById('customTimeInput').value = customTime;
        
        // ÁßªÈô§ÊâÄÊúâÈ¢ÑËÆæÊåâÈíÆÁöÑÊøÄÊ¥ªÁä∂ÊÄÅ
        const buttons = document.querySelectorAll('.time-btn');
        buttons.forEach(btn => btn.classList.remove('active'));
      }
    }
  }
  
  // ‰øùÂ≠òÁî®Êà∑ÂÖ≥‰∫éÊòØÂê¶ÊØèÊ¨°ÂêØÂä®ÈÉΩÊòæÁ§∫ËÆæÁΩÆÂØπËØùÊ°ÜÁöÑÈÄâÊã©
  const alwaysShowSettings = document.getElementById('alwaysShowSettings').checked;
  localStorage.setItem('showSettingsOnLoad', alwaysShowSettings ? 'true' : 'false');
  
  // ÊòæÁ§∫ËÆæÁΩÆÊåâÈíÆ
  document.getElementById('settingsButton').style.display = 'block';
  
  // ÂêØÁî®ÂºÄÂßãÊåâÈíÆ
  const startBtn = document.getElementById('startBtn');
  startBtn.disabled = false;
  startBtn.style.opacity = '1';
  
  // ÂÖ≥Èó≠Ê®°ÊÄÅÂØπËØùÊ°Ü
  closeSettingsModal();
}


// È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéËá™Âä®ÊâìÂºÄËÆæÁΩÆÂØπËØùÊ°Ü
window.onload = function() {
  // È°µÈù¢Âä†ËΩΩÊó∂ÂßãÁªàÂºπÂá∫ËÆæÁΩÆÂØπËØùÊ°Ü
  // Á®çÂæÆÂª∂Ëøü‰∏Ä‰∏ãÂÜçÊâìÂºÄÔºåÁ°Æ‰øùÈ°µÈù¢ÂÆåÂÖ®Âä†ËΩΩ
  setTimeout(function() {
    openSettingsModal();
  }, 500);
}

// ÈÄâÊã©È¢ÑËÆæÊó∂Èó¥
function selectTime(seconds, element) {
  selectedTime = seconds;
  timeLeft = seconds;
  
  // Êõ¥Êñ∞ÁïåÈù¢ÊòæÁ§∫
  document.getElementById('timeLeft').textContent = timeLeft;
  document.getElementById('customTimeInput').value = seconds;
  
  // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
  const buttons = document.querySelectorAll('.time-btn');
  buttons.forEach(btn => btn.classList.remove('active'));
  element.classList.add('active');
}

// ËÆæÁΩÆËá™ÂÆö‰πâÊó∂Èó¥
function setCustomTime() {
  const customTime = parseInt(document.getElementById('customTimeInput').value);
  if (customTime >= 30 && customTime <= 1800) {
    selectedTime = customTime;
    timeLeft = customTime;
    
    // Êõ¥Êñ∞ÁïåÈù¢ÊòæÁ§∫
    document.getElementById('timeLeft').textContent = timeLeft;
    
    // ÁßªÈô§ÊâÄÊúâÈ¢ÑËÆæÊåâÈíÆÁöÑÊøÄÊ¥ªÁä∂ÊÄÅ
    const buttons = document.querySelectorAll('.time-btn');
    buttons.forEach(btn => btn.classList.remove('active'));
  } else {
    alert('ËØ∑ËæìÂÖ•30-1800Áßí‰πãÈó¥ÁöÑÊó∂Èó¥ÔºÅ');
  }
}

// Ê£ÄÊü•ÊòØÂê¶Êª°Ë∂≥ÈöæÂ∫¶Ë¶ÅÊ±Ç
function checkDifficulty(num1, num2, operation, difficulty) {
  if (operation === 'addition') {
    // Âä†Ê≥ï
    if (difficulty === 'noCarry') {
      // ‰∏çËøõ‰ΩçÔºö‰∏™‰ΩçÊï∞Áõ∏Âä†‰∏çË∂ÖËøá10
      return (num1 % 10) + (num2 % 10) < 10;
    } else {
      // Ëøõ‰ΩçÔºö‰∏™‰ΩçÊï∞Áõ∏Âä†Ë∂ÖËøáÊàñÁ≠â‰∫é10
      return (num1 % 10) + (num2 % 10) >= 10;
    }
  } else if (operation === 'subtraction') {
    // ÂáèÊ≥ï
    if (difficulty === 'noCarry') {
      // ‰∏çÈÄÄ‰ΩçÔºöË¢´ÂáèÊï∞‰∏™‰ΩçÊï∞Â§ß‰∫éÁ≠â‰∫éÂáèÊï∞‰∏™‰ΩçÊï∞
      return (num1 % 10) >= (num2 % 10);
    } else {
      // ÈÄÄ‰ΩçÔºöË¢´ÂáèÊï∞‰∏™‰ΩçÊï∞Â∞è‰∫éÂáèÊï∞‰∏™‰ΩçÊï∞
      return (num1 % 10) < (num2 % 10);
    }
  } else if (operation === 'multiplication') {
    // ‰πòÊ≥ï
    if (difficulty === 'noCarry') {
      // ‰∏çËøõ‰ΩçÔºö‰∏™‰ΩçÊï∞Áõ∏‰πò‰∏çË∂ÖËøá10
      return (num1 % 10) * (num2 % 10) < 10;
    } else {
      // Ëøõ‰ΩçÔºö‰∏™‰ΩçÊï∞Áõ∏‰πòË∂ÖËøáÊàñÁ≠â‰∫é10
      return (num1 % 10) * (num2 % 10) >= 10;
    }
  } else if (operation === 'division') {
    // Èô§Ê≥ï
    if (difficulty === 'noCarry') {
      // ‰∏çÈÄÄ‰ΩçÔºöÊï¥Èô§
      return num1 % num2 === 0;
    } else {
      // ÈÄÄ‰ΩçÔºö‰∏çËÉΩÊï¥Èô§
      return num1 % num2 !== 0;
    }
  }
  return true;
}

// ÁîüÊàêÈîôËØØÈÄâÈ°π
function generateWrongOption(correctAnswer) {
  // ÁîüÊàê‰∏Ä‰∏™‰∏éÊ≠£Á°ÆÁ≠îÊ°à‰∏çÂêåÁöÑÈöèÊú∫Êï∞
  let wrongOption;
  do {
    // Ê†πÊçÆÊ≠£Á°ÆÁ≠îÊ°àÁöÑÂ§ßÂ∞èËåÉÂõ¥ÁîüÊàêÈîôËØØÈÄâÈ°π
    if (correctAnswer < 10) {
      wrongOption = Math.floor(Math.random() * 20);
    } else if (correctAnswer < 50) {
      wrongOption = Math.floor(Math.random() * 100);
    } else if (correctAnswer < 100) {
      wrongOption = Math.floor(Math.random() * 200);
    } else {
      wrongOption = Math.floor(Math.random() * correctAnswer * 2);
    }
    
    // Á°Æ‰øùÈîôËØØÈÄâÈ°π‰∏ç‰∏∫Ë¥üÊï∞
    wrongOption = Math.abs(wrongOption);
    
    // Á°Æ‰øùÈîôËØØÈÄâÈ°π‰∏çÁ≠â‰∫éÊ≠£Á°ÆÁ≠îÊ°à
    if (wrongOption === correctAnswer) {
      wrongOption = correctAnswer + Math.floor(Math.random() * 10) + 1;
    }
  } while (wrongOption === correctAnswer);
  
  return wrongOption;
}

// ÈöèÊú∫ÁîüÊàêÈ¢òÁõÆ
function generateQuestion() {
  let num1, num2;
  let maxNum = selectedRange;
  
  // Ê†πÊçÆËøêÁÆóÁ±ªÂûãÁîüÊàêÈ¢òÁõÆ
  let isSameAsLast = false;
  if (selectedOperation === 'multiplication') {
    // ‰πòÊ≥ï
    do {
      num1 = Math.floor(Math.random() * Math.min(9, maxNum)) + 1;
      num2 = Math.floor(Math.random() * Math.min(9, maxNum)) + 1;
      // ÈÅøÂÖç1*XÁöÑÈ¢òÁõÆ
      // ÈÅøÂÖç‰∏é‰∏ä‰∏ÄÈ¢òÁõ∏Âêå
      isSameAsLast = (num1 === lastQuestion.num1 && num2 === lastQuestion.num2 && selectedOperation === lastQuestion.operation) ||
                     (num1 === lastQuestion.num2 && num2 === lastQuestion.num1 && selectedOperation === lastQuestion.operation);
    } while (!checkDifficulty(num1, num2, selectedOperation, selectedDifficulty) || 
             num1 === 1 || num2 === 1 || isSameAsLast);
    
    currentAnswer = num1 * num2;
    document.getElementById('question').textContent = `${num1} √ó ${num2} = `;
  } else if (selectedOperation === 'addition') {
    // Âä†Ê≥ï
    do {
      num1 = Math.floor(Math.random() * maxNum) + 1;
      num2 = Math.floor(Math.random() * maxNum) + 1;
      // ÈÅøÂÖç‰∏é‰∏ä‰∏ÄÈ¢òÁõ∏Âêå
      isSameAsLast = (num1 === lastQuestion.num1 && num2 === lastQuestion.num2 && selectedOperation === lastQuestion.operation) ||
                     (num1 === lastQuestion.num2 && num2 === lastQuestion.num1 && selectedOperation === lastQuestion.operation);
    } while (!checkDifficulty(num1, num2, selectedOperation, selectedDifficulty) || isSameAsLast);
    
    currentAnswer = num1 + num2;
    document.getElementById('question').textContent = `${num1} + ${num2} = `;
  } else if (selectedOperation === 'subtraction') {
    // ÂáèÊ≥ï
    do {
      num1 = Math.floor(Math.random() * maxNum) + 1;
      num2 = Math.floor(Math.random() * maxNum) + 1;
      // Á°Æ‰øùÁªìÊûú‰∏∫Ê≠£Êï∞
      if (num1 < num2) {
        [num1, num2] = [num2, num1];
      }
      // ÈÅøÂÖç‰∏é‰∏ä‰∏ÄÈ¢òÁõ∏Âêå
      isSameAsLast = (num1 === lastQuestion.num1 && num2 === lastQuestion.num2 && selectedOperation === lastQuestion.operation);
    } while (!checkDifficulty(num1, num2, selectedOperation, selectedDifficulty) || isSameAsLast);
    
    currentAnswer = num1 - num2;
    document.getElementById('question').textContent = `${num1} - ${num2} = `;
  } else if (selectedOperation === 'division') {
    // Èô§Ê≥ï
    do {
      num2 = Math.floor(Math.random() * (maxNum - 1)) + 1; // Èô§Êï∞‰∏çËÉΩ‰∏∫0
      if (selectedDifficulty === 'noCarry') {
        // Êï¥Èô§ÊÉÖÂÜµÔºöÁîüÊàê‰∏Ä‰∏™ÂÄçÊï∞
        const multiplier = Math.floor(Math.random() * (Math.floor(maxNum / num2) - 1)) + 1;
        num1 = num2 * multiplier;
      } else {
        // ÈùûÊï¥Èô§ÊÉÖÂÜµÔºöÁ°Æ‰øù‰∏çËÉΩÊï¥Èô§
        num1 = Math.floor(Math.random() * maxNum) + 1;
        // Â¶ÇÊûúÈöèÊú∫ÁîüÊàêÁöÑËÉΩÊï¥Èô§ÔºåÂàôË∞ÉÊï¥‰∏Ä‰∏ã
        if (num1 % num2 === 0) {
          num1 = num1 + (num2 === 1 ? 1 : 1); // ÈÅøÂÖçÈô§Êï∞‰∏∫1ÁöÑÊÉÖÂÜµ
          if (num1 > maxNum) num1 = num1 - 2;
        }
      }
      // ÈÅøÂÖçX/XÁöÑÈ¢òÁõÆ
      // ÈÅøÂÖç‰∏é‰∏ä‰∏ÄÈ¢òÁõ∏Âêå
      isSameAsLast = (num1 === lastQuestion.num1 && num2 === lastQuestion.num2 && selectedOperation === lastQuestion.operation);
    } while (!checkDifficulty(num1, num2, selectedOperation, selectedDifficulty) || 
             num1 <= 0 || num2 <= 0 || num1 > maxNum || num2 > maxNum ||
             num1 === num2 || isSameAsLast);
    
    currentAnswer = Math.floor(num1 / num2);
    document.getElementById('question').textContent = `${num1} √∑ ${num2} = `;
  }
  
  // ÁîüÊàêA„ÄÅB„ÄÅCÈÄâÈ°π
  // ÈöèÊú∫ÂÜ≥ÂÆöÊ≠£Á°ÆÁ≠îÊ°àÊîæÂú®Âì™‰∏™ÈÄâÈ°π
  const optionPositions = ['A', 'B', 'C'];
  correctOption = optionPositions[Math.floor(Math.random() * 3)];
  
  if (correctOption === 'A') {
    optionA = currentAnswer;
    optionB = generateWrongOption(currentAnswer);
    optionC = generateWrongOption(currentAnswer);
    // Á°Æ‰øùÈÄâÈ°πC‰∏éÈÄâÈ°πB‰∏çÂêå
    while (optionC === optionB) {
      optionC = generateWrongOption(currentAnswer);
    }
  } else if (correctOption === 'B') {
    optionB = currentAnswer;
    optionA = generateWrongOption(currentAnswer);
    optionC = generateWrongOption(currentAnswer);
    // Á°Æ‰øùÈÄâÈ°πC‰∏éÈÄâÈ°πA‰∏çÂêå
    while (optionC === optionA) {
      optionC = generateWrongOption(currentAnswer);
    }
  } else {
    optionC = currentAnswer;
    optionA = generateWrongOption(currentAnswer);
    optionB = generateWrongOption(currentAnswer);
    // Á°Æ‰øùÈÄâÈ°πB‰∏éÈÄâÈ°πA‰∏çÂêå
    while (optionB === optionA) {
      optionB = generateWrongOption(currentAnswer);
    }
  }
  
  // Êõ¥Êñ∞ÈÄâÈ°πÊòæÁ§∫
  document.getElementById('optionAText').textContent = optionA;
  document.getElementById('optionBText').textContent = optionB;
  document.getElementById('optionCText').textContent = optionC;
  
  // ÈáçÁΩÆÈÄâÈ°πÊåâÈíÆÊ†∑Âºè
  document.getElementById('optionA').style.backgroundColor = '#007aff';
  document.getElementById('optionB').style.backgroundColor = '#007aff';
  document.getElementById('optionC').style.backgroundColor = '#007aff';
  document.getElementById('optionA').style.borderColor = '';
  document.getElementById('optionB').style.borderColor = '';
  document.getElementById('optionC').style.borderColor = '';
  
  hasAnswered = false; // ÈáçÁΩÆÁ≠îÈ¢òÁä∂ÊÄÅ
  
  document.getElementById('answerInput').value = '';
  document.getElementById('answerInput').style.display = 'none'; // ÈöêËóèËæìÂÖ•Ê°Ü
  document.getElementById('optionsContainer').style.display = 'block'; // ÊòæÁ§∫ÈÄâÈ°π
  document.getElementById('feedback').textContent = '';
  document.getElementById('feedback').className = 'feedback';
  
  // ‰øùÂ≠òÂΩìÂâçÈ¢òÁõÆ‰ø°ÊÅØÔºåÁî®‰∫é‰∏ã‰∏ÄÊ¨°ÊØîËæÉ
  lastQuestion.num1 = num1;
  lastQuestion.num2 = num2;
  lastQuestion.operation = selectedOperation;
  lastQuestion.answer = currentAnswer;
  
  // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊó∂Âô®
  if (inputTimer) {
    clearTimeout(inputTimer);
    inputTimer = null;
  }
}

// ÂºÄÂßãÊ∏∏Êàè
function startGame() {
  // ÂàùÂßãÂåñÈü≥È¢ëÔºàÈúÄË¶ÅÁî®Êà∑‰∫§‰∫íÔºâ
  initAudio();
  
  gameActive = true;
  currentScore = 0;
  timeLeft = selectedTime; // ‰ΩøÁî®Áî®Êà∑ÈÄâÊã©ÁöÑÊó∂Èó¥
  totalQuestions = 0;
  correctAnswers = 0;
  wrongAnswers = 0;
  
  // Êõ¥Êñ∞UI
  document.getElementById('currentScore').textContent = currentScore;
  document.getElementById('timeLeft').textContent = timeLeft;
  document.getElementById('startBtn').style.display = 'none';
  document.getElementById('restartBtn').style.display = 'none';
  document.getElementById('answerInput').style.display = 'none'; // ÈöêËóèËæìÂÖ•Ê°Ü
  document.getElementById('optionsContainer').style.display = 'block'; // ÊòæÁ§∫ÈÄâÈ°π
  document.getElementById('gameOver').style.display = 'none';
  document.getElementById('gameSettings').style.display = 'none'; // ÈöêËóèÊ∏∏ÊàèËÆæÁΩÆ
  document.getElementById('timeSettings').style.display = 'none'; // ÈöêËóèÊó∂Èó¥ËÆæÁΩÆ
  
  // ÂºÄÂßãËÆ°Êó∂
  timer = setInterval(() => {
    timeLeft--;
    document.getElementById('timeLeft').textContent = timeLeft;
    if (timeLeft <= 0) {
      endGame();
    }
  }, 1000);
  
  // ÁîüÊàêÁ¨¨‰∏ÄÈ¢ò
  generateQuestion();
  updateStats();
}

// ÈÄâÊã©ÈÄâÈ°π
function selectOption(selected) {
  if (!gameActive || hasAnswered) return;
  
  hasAnswered = true; // Ê†áËÆ∞Â∑≤Á≠îÈ¢òÔºåÈò≤Ê≠¢ÈáçÂ§çÈÄâÊã©
  totalQuestions++;
  
  const feedback = document.getElementById('feedback');
  
  // È´ò‰∫ÆÊòæÁ§∫Áî®Êà∑ÈÄâÊã©ÁöÑÈÄâÈ°π
  if (selected === 'A') {
    document.getElementById('optionA').style.backgroundColor = '#0056cc';
  } else if (selected === 'B') {
    document.getElementById('optionB').style.backgroundColor = '#0056cc';
  } else if (selected === 'C') {
    document.getElementById('optionC').style.backgroundColor = '#0056cc';
  }
  
  // Ê£ÄÊü•Á≠îÊ°àÊòØÂê¶Ê≠£Á°Æ
  if (selected === correctOption) {
    // Á≠îÂØπ‰∫Ü
    correctAnswers++;
    currentScore += 10;
    
    // È´ò‰∫ÆÊòæÁ§∫Ê≠£Á°ÆÈÄâÈ°π‰∏∫ÁªøËâ≤
    if (correctOption === 'A') {
      document.getElementById('optionA').style.backgroundColor = '#34c759';
    } else if (correctOption === 'B') {
      document.getElementById('optionB').style.backgroundColor = '#34c759';
    } else if (correctOption === 'C') {
      document.getElementById('optionC').style.backgroundColor = '#34c759';
    }
    
    feedback.textContent = 'üéâ Á≠îÂØπ‰∫ÜÔºÅ+10ÂàÜ';
    feedback.className = 'feedback correct';
    playSound('correctSound'); // Êí≠ÊîæÊ≠£Á°ÆÈü≥Êïà
  } else {
    // Á≠îÈîô‰∫Ü
    wrongAnswers++;
    
    // È´ò‰∫ÆÊòæÁ§∫ÈîôËØØÈÄâÈ°π‰∏∫Á∫¢Ëâ≤
    if (selected === 'A') {
      document.getElementById('optionA').style.backgroundColor = '#ff3b30';
    } else if (selected === 'B') {
      document.getElementById('optionB').style.backgroundColor = '#ff3b30';
    } else if (selected === 'C') {
      document.getElementById('optionC').style.backgroundColor = '#ff3b30';
    }
    
    // È´ò‰∫ÆÊòæÁ§∫Ê≠£Á°ÆÈÄâÈ°π‰∏∫ÁªøËâ≤
    if (correctOption === 'A') {
      document.getElementById('optionA').style.backgroundColor = '#34c759';
    } else if (correctOption === 'B') {
      document.getElementById('optionB').style.backgroundColor = '#34c759';
    } else if (correctOption === 'C') {
      document.getElementById('optionC').style.backgroundColor = '#34c759';
    }
    
    feedback.textContent = `‚ùå Á≠îÈîô‰∫ÜÔºÅÊ≠£Á°ÆÁ≠îÊ°àÊòØ ${currentAnswer}`;
    feedback.className = 'feedback incorrect';
    playSound('wrongSound'); // Êí≠ÊîæÈîôËØØÈü≥Êïà
  }
  
  // Êõ¥Êñ∞ÊòæÁ§∫
  document.getElementById('currentScore').textContent = currentScore;
  updateStats();
  
  // Ëá™Âä®ËøõÂÖ•‰∏ã‰∏ÄÈ¢ò
  setTimeout(() => {
    if (gameActive) {
      generateQuestion();
    }
  }, 1500);
}

// Ê£ÄÊü•Á≠îÊ°àÔºà‰øùÁïôÂéüÊù•ÁöÑÂáΩÊï∞‰ª•‰øùÊåÅÂÖºÂÆπÊÄßÔºâ
function checkAnswer() {
  if (!gameActive || hasAnswered) return;
  
  const userAnswer = parseInt(document.getElementById('answerInput').value);
  const input = document.getElementById('answerInput');
  const feedback = document.getElementById('feedback');
  
  if (isNaN(userAnswer)) {
    feedback.textContent = 'ËØ∑ËæìÂÖ•‰∏Ä‰∏™Êï∞Â≠óÔºÅ';
    feedback.className = 'feedback incorrect';
    return;
  }
  
  hasAnswered = true; // Ê†áËÆ∞Â∑≤Á≠îÈ¢òÔºåÈò≤Ê≠¢ÈáçÂ§çÊ†°È™å
  totalQuestions++;
  
  // Ê∏ÖÈô§ËæìÂÖ•ÂÆöÊó∂Âô®
  if (inputTimer) {
    clearTimeout(inputTimer);
    inputTimer = null;
  }
  
  if (userAnswer === currentAnswer) {
    // Á≠îÂØπ‰∫Ü
    correctAnswers++;
    currentScore += 10;
    input.className = 'answer-input correct';
    feedback.textContent = 'üéâ Á≠îÂØπ‰∫ÜÔºÅ+10ÂàÜ';
    feedback.className = 'feedback correct';
    playSound('correctSound'); // Êí≠ÊîæÊ≠£Á°ÆÈü≥Êïà
  } else {
    // Á≠îÈîô‰∫Ü
    wrongAnswers++;
    input.className = 'answer-input incorrect';
    feedback.textContent = `‚ùå Á≠îÈîô‰∫ÜÔºÅÊ≠£Á°ÆÁ≠îÊ°àÊòØ ${currentAnswer}`;
    feedback.className = 'feedback incorrect';
    playSound('wrongSound'); // Êí≠ÊîæÈîôËØØÈü≥Êïà
  }
  
  // Êõ¥Êñ∞ÊòæÁ§∫
  document.getElementById('currentScore').textContent = currentScore;
  updateStats();
  
  // Ëá™Âä®ËøõÂÖ•‰∏ã‰∏ÄÈ¢ò
  setTimeout(() => {
    if (gameActive) {
      generateQuestion();
    }
  }, 1500);
}



// Êõ¥Êñ∞ÁªüËÆ°Êï∞ÊçÆ
function updateStats() {
  document.getElementById('totalQuestions').textContent = totalQuestions;
  document.getElementById('correctAnswers').textContent = correctAnswers;
  document.getElementById('wrongAnswers').textContent = wrongAnswers;
  
  const accuracy = totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0;
  document.getElementById('accuracy').textContent = accuracy + '%';
}

// ÁªìÊùüÊ∏∏Êàè
function endGame() {
  gameActive = false;
  clearInterval(timer);
  
  // ÈöêËóèÊ∏∏ÊàèÂÖÉÁ¥†
  document.getElementById('answerInput').style.display = 'none';
  document.getElementById('restartBtn').style.display = 'inline-block';
  
  // ÊòæÁ§∫ÁªìÊûú
  const gameOver = document.getElementById('gameOver');
  gameOver.style.display = 'block';
  
  document.getElementById('finalScore').textContent = `ÊúÄÁªàÂæóÂàÜ: ${currentScore} ÂàÜ`;
  
  const accuracy = totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0;
  document.getElementById('finalStats').innerHTML = `
    <p>ÊÄªÂÖ±ÂÆåÊàê ${totalQuestions} ÈÅìÈ¢ò</p>
    <p>Á≠îÂØπ ${correctAnswers} È¢òÔºåÁ≠îÈîô ${wrongAnswers} È¢ò</p>
    <p>Ê≠£Á°ÆÁéá: ${accuracy}%</p>
    ${accuracy >= 90 ? '<p>üèÜ ‰ºòÁßÄÔºÅ‰Ω†ÊòØ‰πòÊ≥ïÂ∞èËÉΩÊâãÔºÅ</p>' : 
      accuracy >= 70 ? '<p>üëç ‰∏çÈîôÔºÅÁªßÁª≠Âä™ÂäõÔºÅ</p>' : 
      '<p>üí™ Âä†Ê≤πÔºÅÂ§öÂ§öÁªÉ‰π†‰ºöÊõ¥Â•ΩÔºÅ</p>'}
  `;
  
  document.getElementById('question').textContent = 'Ê∏∏ÊàèÁªìÊùüÔºÅ';
}

// ÈáçÊñ∞ÂºÄÂßãÊ∏∏Êàè
function restartGame() {
  // Ê∏ÖÈô§‰ªª‰ΩïÊ≠£Âú®ËøõË°åÁöÑÂÆöÊó∂Âô®
  if (inputTimer) {
    clearTimeout(inputTimer);
    inputTimer = null;
  }
  
  document.getElementById('startBtn').style.display = 'inline-block';
  document.getElementById('restartBtn').style.display = 'none';
  document.getElementById('gameOver').style.display = 'none';
  document.getElementById('gameSettings').style.display = 'block'; // ÊòæÁ§∫Ê∏∏ÊàèËÆæÁΩÆ
  document.getElementById('timeSettings').style.display = 'block'; // ÊòæÁ§∫Êó∂Èó¥ËÆæÁΩÆ
  document.getElementById('optionsContainer').style.display = 'none'; // ÈöêËóèÈÄâÈ°π
  document.getElementById('question').textContent = 'ÁÇπÂáªÂºÄÂßãÊåâÈíÆÂºÄÂßãÊ∏∏ÊàèÔºÅ';
  document.getElementById('feedback').textContent = '';
  document.getElementById('feedback').className = 'feedback';
  
  // ÈáçÁΩÆÈÄâÈ°πÊåâÈíÆÊ†∑Âºè
  document.getElementById('optionA').style.backgroundColor = '#007aff';
  document.getElementById('optionB').style.backgroundColor = '#007aff';
  document.getElementById('optionC').style.backgroundColor = '#007aff';
}

// ËæìÂÖ•‰∫ã‰ª∂ÁõëÂê¨Âô® - ÂÆûÁé∞ÂÅúÊ≠¢ËæìÂÖ•Êó∂Ëá™Âä®Ê†°È™å
document.getElementById('answerInput').addEventListener('input', function(e) {
  if (!gameActive || hasAnswered) return;
  
  const value = this.value.trim();
  
  // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊó∂Âô®
  if (inputTimer) {
    clearTimeout(inputTimer);
    inputTimer = null;
  }
  
  // Â¶ÇÊûúËæìÂÖ•‰∫ÜÊúâÊïàÊï∞Â≠óÔºåËÆæÁΩÆÂÆöÊó∂Âô®
  if (value !== '' && !isNaN(parseInt(value))) {
    inputTimer = setTimeout(() => {
      if (gameActive && !hasAnswered && this.value.trim() !== '') {
        checkAnswer();
      }
    }, 800); // 800ÊØ´ÁßíÂêéËá™Âä®Ê†°È™å
  }
});

// ÂõûËΩ¶ÈîÆÁ´ãÂç≥Êèê‰∫§Á≠îÊ°à
document.getElementById('answerInput').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    checkAnswer();
  }
});

// ËæìÂÖ•Ê°ÜÂ§±ÂéªÁÑ¶ÁÇπÊó∂‰πüÊ£ÄÊü•Á≠îÊ°à
document.getElementById('answerInput').addEventListener('blur', function() {
  if (gameActive && !hasAnswered && this.value.trim() !== '') {
    setTimeout(() => checkAnswer(), 100);
  }
});
</script>
</body>
</html>
